---
# framework implementation

apiVersion: kudo.k8s.io/v1alpha1
kind: FrameworkVersion
metadata:
  name: elastic-v1
  namespace: default
  labels:
    controller-tools.k8s.io: "1.0"
spec:
  version: "1.0.0"
  connectionString: ""
  framework:
    name: elastic
    kind: Framework
  parameters:
    - name: NODE_COUNT
      default: "3"
  templates:
    service.yaml: |
      kind: Service
      apiVersion: v1
      metadata:
        name: hs
        namespace: {{ .Namespace }}
      spec:
        selector:
          app: elastic
        ports:
          - protocol: TCP
            port: 9200
        clusterIP: None
    node.yaml: |
      kind: StatefulSet
      apiVersion: apps/v1
      metadata:
        name: node
        namespace: {{ .Namespace }}
      spec:
        selector:
          matchLabels:
            app: elastic # has to match .spec.template.metadata.labels
        serviceName: {{ .Name }}-hs
        replicas: {{ .Params.NODE_COUNT }}
        template:
          metadata:
            labels:
              app: elastic # has to match .spec.selector.matchLabels
          spec:
            initContainers:
              - name: init-sysctl
                image: busybox
                command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
                securityContext:
                  privileged: true
              - name: volume-permissions
                image: busybox
                command: ['sh', '-c', 'chown -R 1000:1000 /usr/share/elasticsearch/data']
                volumeMounts:
                  - name: data
                    mountPath: /usr/share/elasticsearch/data
            terminationGracePeriodSeconds: 10
            containers:
              - name: elastic
                image: elasticsearch:7.0.0
                ports:
                  - containerPort: 9200
                    name: api
                  - containerPort: 9300
                    name:
                env:
                  - name: cluster.name
                    value: {{ .Name }}-cluster
                  - name: discovery.seed_hosts
                    value: {{ .Name }}-node-0.{{ .Name }}-hs,{{ .Name }}-node-1.{{ .Name }}-hs,{{ .Name }}-node-2.{{ .Name }}-hs
                  - name: cluster.initial_master_nodes
                    value: {{ .Name }}-node-0,{{ .Name }}-node-1,{{ .Name }}-node-2
                volumeMounts:
                  - name: data
                    mountPath: /usr/share/elasticsearch/data
        volumeClaimTemplates:
          - metadata:
              name: data
            spec:
              accessModes: [ "ReadWriteOnce" ]
              resources:
                requests:
                  storage: 1Gi
  tasks:
    deploy-task:
      resources:
        - service.yaml
        - node.yaml
  plans:
    deploy:
      strategy: serial
      phases:
        - name: deploy-phase
          strategy: parallel
          steps:
            - name: deploy-step
              tasks:
                - deploy-task
